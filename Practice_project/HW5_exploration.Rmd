---
title: "HW5: exploring health of people "
author: "Santina"
date: "Monday, October 13, 2014"
output: 
  html_document: 
    keep_md: true
    toc: yes
    toc_depth: 4 
    theme: united
---

There has been a lot of exploration on the gapminder data, especially with life expectancies. We all know that the general trends for most countries, except a few countries that have went through genocides or other significant events, are upward increase of life expectancies. However, we also heard of anedotes such as Americans are eating less healthy and eating less healthy, or that cancer has become one major killer of people in the west. 

So in this assignment, I'm interested to see the "overall health" of the people, as measured by some randomly chosen factors (by me), including BMI, blood pressure, cholesterol levels, in countries where life expectancies are high. In other words, I want to see if those risk factors are going down and thus perhaps contributing to the increasing life expectancies or that they are going up. 

First load the needed packages  
```{r, message=FALSE}
library(ggplot2)  # for making plots
library(ggthemes) # for customizaing ggplot graphs
library(scales)   # for graphs scale
library(plyr)     # for easy computation with data frames
library(dplyr)    # do this after loading plyr
library(knitr)    # for rendering pretty tables
library(gdata)    # for reading excel files
library(robustbase)#for lmrob function, robust linear regression
```

And then the needed datatsets 

```{r, message=FALSE}
#our old friend gapminder data, for life expectancy 
gdURL <- "http://tiny.cc/gapminder"
data  <- read.delim(file = gdURL) 

#Risk factor data (source: http://www.gapminder.org/data/)
#read excel sheets with XLConnect 
require(XLConnect) #for reading excel files 

# BMI: 
BMIf = loadWorkbook("./Databank/BMI_female.xlsx")
BMI_female = readWorksheet(BMIf, sheet = "data", header = TRUE)

BMIm = loadWorkbook("./Databank/BMI_male.xlsx")
BMI_male = readWorksheet(BMIm, sheet = "data", header = TRUE)

# Cholesterol (fat) in blood, women, male, mmol/L
TC_f = loadWorkbook("./Databank/TC_female.xlsx")
TC_female = readWorksheet(TC_f, sheet = "data", header = TRUE)

TC_m = loadWorkbook("./Databank/TC_male.xlsx")
TC_male = readWorksheet(TC_m, sheet = "data", header = TRUE)

# SBP (systolic blood pressure)
SBP_f = loadWorkbook("./Databank/SBP_female.xlsx")
SBP_female = readWorksheet(SBP_f, sheet = "data", header = TRUE)

SBP_m = loadWorkbook("./Databank/SBP_male.xlsx")
SBP_male = readWorksheet(SBP_m, sheet = "data", header = TRUE)
```

Now, I will find the countries with the highest life expectancies.  

```{r, results="asis"}
life <- data %>%
  filter(year == 2007) %>%
  select(country, lifeExp) %>%
  arrange(desc(lifeExp)) #from greater to smaller
kable(life[1:5,], format = "pandoc", caption = "Top 5 countries with greatest life expectancies in 2007")
```


Now we can start looking at the risk factors. But first, let's take a peak at one of the datasets 

```{r, results="asis"}
kable(head(BMI_female, 3))
```

Looks like the column names has been changed from years to "col#", so we'll change it back for easy access. 

```{r}
colnames(BMI_female) <- c("country", 1980:2008) 
colnames(BMI_male)   <- c("country", 1980:2008)

colnames(TC_female)  <- c("country", 1980:2008)
colnames(TC_male)    <- c("country", 1980:2008)

colnames(SBP_female) <- c("country", 1980:2008)
colnames(SBP_male)   <- c("country", 1980:2008)
```

Yes, the data sets for each risk factor are separately collected for male and female. I want to use a facet-wrap to show each country in a separate graph, and each graph with female and male. To do that, I'd have to merge the selected subsets from each data set together somehow. First, let's check if the data sets have all the five countries we want to look at: 

```{r}
#extract the top five countries names
countries  <- life[1:5,]$country 
#make a list of data sets
datalist <- list(BMI_female,BMI_male,TC_female,TC_male,SBP_female,SBP_male)
#check if countries exist in all thse data sets using the fact
# that sum of booleans is the number of TRUE (so all should equal to 5)
exist  <- lapply(datalist, function(x){sum(countries[1:5] %in% x$country)})
exist 

```
Since they are all 5, that means all the data sets contain the information for the countries we want to examine. Now we merge the information together: 

```{r, results="asis"}
mergedData  <- data.frame()


list <- lapply(datalist, function(x){
  data_sub  <- x %>% filter(country %in% countries)
  #convert name of the object into a string, repeate 5 times (number of countries)
  categorynames <- rep(deparse(substitute(x)), length(countries))  
  #now bind this categories name into the data frame as a new column 'category'
  data_sub <- data_sub %>% mutate(category = categorynames)
})

  
  #merge this subset with the existing data 
  mergedData  <- rbind(mergedData, data_sub)

kable(mergedData) # see the side effect of lapply

```

```{r}
ggplot(lifeExp_con, aes(year, con_lifeExp, colour = continent)) +
  facet_wrap( ~ continent, ncol = 3) +
  theme(legend.position = "none") +
  xlab("Year") +
  ylab("Life Expectancy")+
  ggtitle("Weighted average over year")+
  geom_line()+
  theme_bw()
```

